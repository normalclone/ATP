<div class="alerts-page">
  <header class="page-header">
    <div>
      <h1 class="page-title">C·∫£nh b√°o &amp; Ph√¢n t√≠ch l·ªói</h1>
      <p class="page-subtitle">Theo d√µi l·ªói, flaky test, xu h∆∞·ªõng v√† r·ªßi ro ch·∫•t l∆∞·ª£ng theo th·ªùi gian.</p>
    </div>
    <div class="header-actions">
      <select [(ngModel)]="dateRange">
        <option>7 ng√†y g·∫ßn ƒë√¢y</option>
        <option>14 ng√†y</option>
        <option>30 ng√†y</option>
      </select>
      <select [(ngModel)]="projectFilter">
        <option>T·∫•t c·∫£ project</option>
        <option>DVCLT</option>
        <option>CSKCB_V2</option>
        <option>CTDL</option>
      </select>
      <button class="btn btn-ghost btn-sm">Refresh</button>
    </div>
  </header>

  <section class="summary-bar">
    <article class="summary-card" *ngFor="let item of summaryItems" [ngClass]="item.badgeTone">
      <p class="summary-label">{{ item.label }}</p>
      <p class="summary-value">{{ item.value }}</p>
      <p class="summary-sub" *ngIf="item.subLabel">{{ item.subLabel }}</p>
    </article>
  </section>

  <section class="charts-grid">
    <article class="panel chart-card">
      <div class="panel-header">
        <div>
          <p class="panel-title">Xu h∆∞·ªõng failed tests</p>
          <p class="panel-sub">S·ªë l∆∞·ª£ng test fail theo ng√†y trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</p>
        </div>
      </div>
      <div class="chart-placeholder">
        <div class="trend-list">
          <div class="trend-row" *ngFor="let item of failureTrend">
            <span class="trend-day">{{ item.day }}</span>
            <div class="trend-bars">
              <span class="bar bar-fail" [style.width.%]="item.fail * 8"></span>
              <span class="bar bar-flaky" [style.width.%]="item.flaky * 8"></span>
            </div>
            <span class="trend-values">{{ item.fail }} fail / {{ item.flaky }} flaky</span>
          </div>
        </div>
      </div>
    </article>

    <article class="panel chart-card">
      <div class="panel-header">
        <div>
          <p class="panel-title">Top module l·ªói nhi·ªÅu</p>
          <p class="panel-sub">Top 5 module c√≥ nhi·ªÅu l·ªói nh·∫•t.</p>
        </div>
      </div>
      <div class="chart-placeholder">
        <div class="bar-list">
          <div class="bar-row" *ngFor="let m of topModules">
            <span class="bar-label">{{ m.module }}</span>
            <div class="bar-track">
              <span class="bar bar-fail" [style.width.%]="m.fails * 5"></span>
            </div>
            <span class="bar-value">{{ m.fails }}</span>
          </div>
        </div>
      </div>
    </article>

    <article class="panel chart-card">
      <div class="panel-header">
        <div>
          <p class="panel-title">Ph√¢n lo·∫°i l·ªói</p>
          <p class="panel-sub">Timeout, Element not found, API 5xx, Assertion, Data...</p>
        </div>
      </div>
      <div class="chart-placeholder">
        <div class="pie-list">
          <div class="pie-row" *ngFor="let e of errorTypes">
            <span class="pie-label">{{ e.type }}</span>
            <span class="pie-value">{{ e.percent }}%</span>
          </div>
        </div>
      </div>
    </article>

    <article class="panel chart-card">
      <div class="panel-header">
        <div>
          <p class="panel-title">Pass / Fail ratio</p>
          <p class="panel-sub">T·ªâ l·ªá test pass/fail/skipped.</p>
        </div>
      </div>
      <div class="chart-placeholder">
        <div class="pie-list">
          <div class="pie-row" *ngFor="let r of passFailRatio">
            <span class="pie-label">{{ r.label }}</span>
            <span class="pie-value">{{ r.percent }}%</span>
          </div>
        </div>
      </div>
    </article>
  </section>

  <section class="split">
    <article class="panel alerts-panel">
      <div class="panel-header">
        <div>
          <p class="panel-title">Danh s√°ch c·∫£nh b√°o</p>
          <p class="panel-sub">L·ªçc theo m·ª©c ƒë·ªô, module, testcase.</p>
        </div>
        <div class="filters">
          <input class="input" type="search" placeholder="T√¨m theo n·ªôi dung c·∫£nh b√°o, module, testcase..." />
          <select [(ngModel)]="severityFilter">
            <option>T·∫•t c·∫£</option>
            <option>Cao</option>
            <option>Trung b√¨nh</option>
            <option>Th·∫•p</option>
          </select>
        </div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="width:10%;">M·ª©c ƒë·ªô</th>
              <th style="width:40%;">C·∫£nh b√°o</th>
              <th style="width:15%;">Module</th>
              <th style="width:10%;">L·∫ßn xu·∫•t hi·ªán</th>
              <th style="width:15%;">G·∫ßn nh·∫•t</th>
              <th style="width:10%;"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let alert of alerts">
              <td>
                <span class="badge" [ngClass]="severityClass(alert.severity)">
                  {{ alert.severity === 'high' ? 'Cao' : alert.severity === 'medium' ? 'Trung b√¨nh' : 'Th·∫•p' }}
                </span>
              </td>
              <td>
                <div class="text-strong">{{ alert.title }}</div>
                <div class="text-muted">Testcase: {{ alert.testcaseKey }} ‚Ä¢ Run: {{ alert.lastRunId }}</div>
              </td>
              <td class="text-muted">{{ alert.module }}</td>
              <td class="text-muted">{{ alert.occurrences }}</td>
              <td class="text-muted">{{ alert.lastSeen }}</td>
              <td class="text-right">
                <button class="btn btn-ghost btn-xs" type="button" (click)="openAlertDrawer(alert)" title="Xem chi ti·∫øt">üëÅ</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </article>

    <article class="panel right-panel">
      <div class="panel-header">
        <div class="panel-title">Ph√¢n t√≠ch n√¢ng cao</div>
        <div class="panel-sub">Flaky test ‚Ä¢ R·ªßi ro module ‚Ä¢ Root cause</div>
      </div>
      <div class="tabs">
        <button class="tab" [class.active]="activeRightTab === 'flaky'" (click)="activeRightTab = 'flaky'">Flaky Test</button>
        <button class="tab" [class.active]="activeRightTab === 'module'" (click)="activeRightTab = 'module'">C·∫£nh b√°o module</button>
        <button class="tab" [class.active]="activeRightTab === 'root'" (click)="activeRightTab = 'root'">Root Cause</button>
      </div>

      <ng-container [ngSwitch]="activeRightTab">
        <ng-container *ngSwitchCase="'flaky'">
          <div class="panel-subtitle">Flaky Test Analyzer</div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Testcase</th>
                  <th style="width:15%;">Flaky %</th>
                  <th style="width:15%;">S·ªë l·∫ßn ch·∫°y</th>
                  <th style="width:15%;">G·∫ßn nh·∫•t</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of flakyRows">
                  <td>{{ row.testcaseKey }}</td>
                  <td><span class="badge" [ngClass]="flakyBadgeClass(row.flakyScore)">{{ row.flakyScore }}%</span></td>
                  <td class="text-muted">{{ row.runsCount }}</td>
                  <td>
                    <span class="badge" [ngClass]="row.lastStatus === 'fail' ? 'badge-danger' : row.lastStatus === 'pass' ? 'badge-success' : 'badge-primary'">
                      {{ row.lastStatus | uppercase }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>

        <ng-container *ngSwitchCase="'module'">
          <div class="panel-subtitle">C·∫£nh b√°o theo module</div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Module</th>
                  <th style="width:15%;">Risk</th>
                  <th style="width:20%;">Xu h∆∞·ªõng l·ªói</th>
                  <th style="width:20%;">Coverage (Auto)</th>
                  <th style="width:20%;">Thay ƒë·ªïi g·∫ßn ƒë√¢y</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of moduleRiskRows">
                  <td>{{ row.module }}</td>
                  <td><span class="badge" [ngClass]="riskBadgeClass(row.riskLevel)">{{ row.riskLevel }}</span></td>
                  <td class="text-muted">{{ row.failureTrend }}</td>
                  <td class="text-muted">{{ row.coverage }}</td>
                  <td class="text-muted">{{ row.recentChanges }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>

        <ng-container *ngSwitchCase="'root'">
          <div class="panel-subtitle">Root Cause Analysis</div>
          <div class="rc-block" *ngFor="let block of rootCauseBlocks">
            <div class="rc-title">{{ block.title }}</div>
            <div class="rc-content">{{ block.content }}</div>
          </div>
        </ng-container>
      </ng-container>
    </article>
  </section>
</div>

<div *ngIf="showAlertDrawer && selectedAlert" class="drawer-overlay">
  <div class="drawer">
    <header class="drawer-header">
      <div>
        <p class="drawer-title">{{ selectedAlert.title }}</p>
        <p class="drawer-sub">Testcase: {{ selectedAlert.testcaseKey }} ‚Ä¢ Run: {{ selectedAlert.lastRunId }}</p>
      </div>
      <button class="close-btn" (click)="closeAlertDrawer()">‚úï</button>
    </header>
    <div class="drawer-body">
      <p><strong>M·ª©c ƒë·ªô:</strong> {{ selectedAlert.severity }}</p>
      <p><strong>Module:</strong> {{ selectedAlert.module }}</p>
      <p><strong>L·∫ßn xu·∫•t hi·ªán:</strong> {{ selectedAlert.occurrences }}</p>
      <p><strong>G·∫ßn nh·∫•t:</strong> {{ selectedAlert.lastSeen }}</p>
      <p><strong>M√¥ t·∫£:</strong> Chi ti·∫øt l·ªói, pattern, log... (mock)</p>
    </div>
    <footer class="drawer-footer">
      <button class="btn btn-primary btn-sm" type="button">M·ªü Test Run g·∫ßn nh·∫•t</button>
      <button class="btn btn-ghost btn-sm" type="button" (click)="closeAlertDrawer()">ƒê√≥ng</button>
    </footer>
  </div>
</div>
