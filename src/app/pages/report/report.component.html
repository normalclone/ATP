<div class="space-y-5 lg:space-y-6">
  <nav class="flex items-center gap-2 text-xs text-text-dim">
    <a class="hover:text-text" href="#">AutoTest Portal</a>
    <span class="text-text-dim">/</span>
    <span class="text-text">Run Test</span>
  </nav>

  <header class="rounded-2xl border border-border-soft bg-bg-elev/70 p-5 shadow-soft/40">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
      <div class="space-y-1">
        <h1 class="text-2xl font-semibold text-text">Run Test</h1>
        <p class="text-sm text-text-dim">Theo dõi lịch sử chạy test, kết quả và phân tích chất lượng.</p>
      </div>

      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-end">
        <span class="inline-flex items-center gap-2 rounded-full border border-border-subtle bg-white/5 px-3 py-1.5 text-xs font-semibold text-text">
          <span class="h-2 w-2 rounded-full bg-success"></span>
          AutoTest Portal • Run Test
        </span>
        <span class="text-xs text-text-dim sm:mx-1">ENV: DEV</span>
        <button
          type="button"
          class="focus-ring inline-flex items-center justify-center gap-2 rounded-xl bg-primary px-4 py-2.5 text-sm font-semibold text-text shadow-soft transition hover:bg-primary-hover"
        >
          <lucide-icon name="play" class="h-4 w-4"></lucide-icon>
          <span>Run now</span>
        </button>
      </div>
    </div>
  </header>

  <section class="summary-grid">
    <div
      *ngFor="let card of summaryCards"
      class="summary-card"
      [ngClass]="card.tone"
    >
      <div class="flex items-center justify-between gap-2">
        <p class="text-sm text-text-dim">{{ card.label }}</p>
        <span class="badge subtle">{{ card.badge }}</span>
      </div>
      <p class="mt-2 text-2xl font-semibold text-text">{{ card.value }}</p>
    </div>
  </section>

  <section class="rounded-2xl border border-border-soft bg-bg-elev/70 p-4 lg:p-5 shadow-soft/30 space-y-4">
    <div class="filter-grid">
      <label class="filter-item">
        <span class="text-xs text-text-dim">Search</span>
        <div class="filter-control">
          <lucide-icon name="search" class="h-4 w-4 text-text-dim"></lucide-icon>
          <input
            [(ngModel)]="searchText"
            type="search"
            class="input"
            placeholder="Tìm theo Run ID, branch, commit..."
          />
        </div>
      </label>

      <label class="filter-item">
        <span class="text-xs text-text-dim">Branch</span>
        <select class="select" [(ngModel)]="branch">
          <option *ngFor="let opt of branchOptions" [ngValue]="opt">{{ opt }}</option>
        </select>
      </label>

      <label class="filter-item">
        <span class="text-xs text-text-dim">Environment</span>
        <select class="select" [(ngModel)]="environment">
          <option *ngFor="let opt of environmentOptions" [ngValue]="opt">{{ opt }}</option>
        </select>
      </label>

      <label class="filter-item">
        <span class="text-xs text-text-dim">Trigger</span>
        <select class="select" [(ngModel)]="trigger">
          <option *ngFor="let opt of triggerOptions" [ngValue]="opt">{{ opt }}</option>
        </select>
      </label>

      <label class="filter-item">
        <span class="text-xs text-text-dim">Ngày chạy</span>
        <select class="select" [(ngModel)]="dateRange">
          <option *ngFor="let opt of dateRangeOptions" [ngValue]="opt">{{ opt }}</option>
        </select>
      </label>

      <div class="flex items-end gap-2">
        <button
          type="button"
          class="focus-ring inline-flex h-10 items-center justify-center gap-2 rounded-xl bg-primary px-4 text-sm font-semibold text-text shadow-soft transition hover:bg-primary-hover w-full sm:w-auto"
          (click)="applyFilters()"
        >
          <lucide-icon name="search" class="h-4 w-4"></lucide-icon>
          <span>Tìm kiếm</span>
        </button>
        <button
          type="button"
          class="focus-ring inline-flex h-10 items-center justify-center gap-2 rounded-xl border border-border-subtle bg-white/5 px-4 text-sm font-semibold text-text transition hover:bg-white/10 w-full sm:w-auto"
          (click)="refreshFilters()"
        >
          <lucide-icon name="refresh-ccw" class="h-4 w-4"></lucide-icon>
          <span>Refresh</span>
        </button>
      </div>
    </div>
  </section>

  <section class="rounded-2xl border border-border-soft bg-bg-elev/80 shadow-soft/40">
    <div class="flex flex-col gap-2 border-b border-border-soft p-4 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <p class="text-sm font-semibold text-text">Run history</p>
        <p class="text-xs text-text-dim">Danh sách các lần chạy test gần đây. Click vào từng dòng để xem chi tiết run.</p>
      </div>
      <button
        type="button"
        class="focus-ring inline-flex items-center gap-2 rounded-xl border border-border-subtle bg-white/5 px-3 py-2 text-sm text-text transition hover:bg-white/10"
        (click)="openLatestRun()"
      >
        <lucide-icon name="bar-chart-3" class="h-4 w-4"></lucide-icon>
        <span>Xem run mới nhất</span>
      </button>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="text-xs uppercase tracking-wide text-text-dim">
          <tr class="border-b border-border-soft text-left">
            <th class="px-4 py-3 w-[90px]">Run ID</th>
            <th class="px-4 py-3 min-w-[140px]">Branch</th>
            <th class="px-4 py-3 w-[90px]">Env</th>
            <th class="px-4 py-3 w-[120px]">Status</th>
            <th class="px-4 py-3 w-[140px]">Tổng (P/F/S)</th>
            <th class="px-4 py-3 w-[110px]">Duration</th>
            <th class="px-4 py-3 w-[120px]">Trigger</th>
            <th class="px-4 py-3 w-[170px]">Thời gian</th>
            <th class="px-4 py-3 min-w-[140px]">Người chạy</th>
            <th class="px-4 py-3 w-[140px] text-right">Action</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border-soft">
          <tr
            *ngFor="let run of pagedRuns"
            class="cursor-pointer transition hover:bg-white/5"
            (click)="openRunDetail(run)"
          >
            <td class="px-4 py-3 font-semibold text-text">{{ run.runId }}</td>
            <td class="px-4 py-3 text-text">{{ run.branch }}</td>
            <td class="px-4 py-3 text-text">{{ run.environment }}</td>
            <td class="px-4 py-3">
              <span [ngClass]="statusBadgeClass(run.status)">{{ statusLabel(run.status) }}</span>
            </td>
            <td class="px-4 py-3 text-text">
              {{ run.totals.passed }} / {{ run.totals.failed }} / {{ run.totals.skipped }}
            </td>
            <td class="px-4 py-3 text-text">{{ run.duration }}</td>
            <td class="px-4 py-3 text-text">{{ run.trigger }}</td>
            <td class="px-4 py-3 text-text">{{ run.runAt }}</td>
            <td class="px-4 py-3 text-text">{{ run.runner }}</td>
            <td class="px-4 py-3 text-right whitespace-nowrap">
              <button
                type="button"
                class="btn-icon btn-ghost btn-xs action-btn"
                (click)="onViewRunReport(run); $event.stopPropagation()"
                title="Xem báo cáo"
              >
                <lucide-icon name="eye" class="h-4 w-4"></lucide-icon>
                <span class="sr-only">Xem</span>
              </button>
              <button
                type="button"
                class="btn-icon btn-ghost btn-xs action-btn"
                (click)="onDownloadRunReport(run); $event.stopPropagation()"
                title="Tải report"
              >
                <lucide-icon name="download" class="h-4 w-4"></lucide-icon>
                <span class="sr-only">Tải</span>
              </button>
            </td>
          </tr>

          <tr *ngIf="!pagedRuns.length">
            <td colspan="9" class="px-4 py-6 text-center">
              <div class="mx-auto flex max-w-md flex-col items-center gap-2">
                <div class="flex h-12 w-12 items-center justify-center rounded-full border border-border-subtle bg-white/5 text-text">
                  <lucide-icon name="activity" class="h-5 w-5"></lucide-icon>
                </div>
                <p class="text-sm font-semibold text-text">Chưa có run nào</p>
                <p class="text-xs text-text-dim">
                  Hãy bỏ bớt bộ lọc hoặc chạy lại job để có dữ liệu.
                </p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="flex flex-wrap items-center justify-between gap-3 border-t border-border-soft bg-bg px-4 py-3 text-xs text-text-dim">
      <span>Hiển thị {{ pagedRuns.length }} / {{ totalItems }} run</span>
      <div class="flex flex-wrap items-center gap-3">
        <label class="flex items-center gap-2">
          <span>Page size</span>
          <select
            class="h-8 rounded-lg border border-border-subtle bg-white/5 px-2 text-xs text-text focus:outline-none focus:ring-2 focus:ring-primary/40"
            [ngModel]="pageSize"
            (ngModelChange)="onPageSizeChange($event)"
          >
            <option *ngFor="let size of pageSizeOptions" [ngValue]="size">{{ size }}</option>
          </select>
        </label>

        <div class="flex items-center gap-1">
          <button
            type="button"
            class="h-8 w-8 rounded-lg border border-border-subtle bg-white/5 text-text-dim transition hover:bg-white/10"
            [disabled]="currentPage === 1"
            (click)="onPageChange(currentPage - 1)"
            aria-label="Previous page"
          >
            ‹
          </button>
          <button
            *ngFor="let page of pageNumbers"
            type="button"
            class="h-8 min-w-[32px] rounded-lg border border-border-subtle bg-white/5 px-2 text-text-dim transition hover:bg-white/10"
            [class.bg-white/15]="page === currentPage"
            [class.text-text]="page === currentPage"
            (click)="onPageChange(page)"
          >
            {{ page }}
          </button>
          <button
            type="button"
            class="h-8 w-8 rounded-lg border border-border-subtle bg-white/5 text-text-dim transition hover:bg-white/10"
            [disabled]="currentPage === totalPages"
            (click)="onPageChange(currentPage + 1)"
            aria-label="Next page"
          >
            ›
          </button>
        </div>
      </div>
    </div>
  </section>
</div>

<div *ngIf="runDetailOpen && selectedRun" class="modal-overlay">
  <div class="modal-card">
    <header class="flex items-start justify-between gap-3 border-b border-border-soft pb-3">
      <div>
        <p class="text-lg font-semibold text-text">
          Run {{ selectedRun.runId }} – {{ selectedRun.branch }} ({{ selectedRun.environment }})
        </p>
        <p class="text-xs text-text-dim">
          Trigger: {{ selectedRun.trigger }} • Duration: {{ selectedRun.duration }} •
          {{ selectedRun.totals.passed + selectedRun.totals.failed + selectedRun.totals.skipped }} tc
          ({{ selectedRun.totals.passed }} pass / {{ selectedRun.totals.failed }} fail / {{ selectedRun.totals.skipped }} skip)
        </p>
      </div>
      <button
        type="button"
        class="rounded-full border border-border-subtle p-1.5 text-text-dim hover:bg-white/5"
        (click)="closeRunDetail()"
        aria-label="Đóng"
      >
        <lucide-icon name="x" class="h-4 w-4"></lucide-icon>
      </button>
    </header>

    <div class="modal-body">
      <div class="tab-list">
        <button
          type="button"
          class="tab-btn"
          [class.active]="activeRunDetailTab === 'overview'"
          (click)="activeRunDetailTab = 'overview'"
        >
          Chi tiết
        </button>
        <button
          type="button"
          class="tab-btn"
          [class.active]="activeRunDetailTab === 'report'"
          (click)="activeRunDetailTab = 'report'"
        >
          HTML Report
        </button>
      </div>

      <div *ngIf="activeRunDetailTab === 'overview'" class="tab-panel">
        <section class="detail-section">
          <p class="section-title">Tổng quan</p>
          <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div class="info-row"><span>Branch</span><strong>{{ selectedRun.branch }}</strong></div>
            <div class="info-row"><span>Environment</span><strong>{{ selectedRun.environment }}</strong></div>
            <div class="info-row"><span>Trigger</span><strong>{{ selectedRun.trigger }}</strong></div>
            <div class="info-row"><span>Commit</span><strong>{{ selectedRun.commit }}</strong></div>
            <div class="info-row"><span>Start time</span><strong>{{ selectedRun.runAt }}</strong></div>
            <div class="info-row"><span>End time</span><strong>--</strong></div>
          </div>
        </section>

        <section class="detail-section">
          <p class="section-title">Kết quả</p>
          <div class="grid gap-3 md:grid-cols-2">
            <div class="flex gap-2">
              <span class="chip success">Pass: {{ selectedRun.totals.passed }}</span>
              <span class="chip danger">Fail: {{ selectedRun.totals.failed }}</span>
              <span class="chip warn">Skip: {{ selectedRun.totals.skipped }}</span>
            </div>
            <div class="chart-placeholder">
              <p class="text-xs text-text-dim">Chart placeholder (Pass/Fail/Skip)</p>
            </div>
          </div>
        </section>

        <section class="detail-section">
          <p class="section-title">Theo module</p>
          <div class="space-y-2">
            <div
              *ngFor="let mod of selectedRun.modules"
              class="flex items-center justify-between rounded-xl border border-border-subtle bg-white/5 px-3 py-2 text-sm text-text"
            >
              <span class="font-semibold">{{ mod.name }}</span>
              <span class="text-text-dim">{{ mod.total }} tc • {{ mod.failed }} fail</span>
            </div>
          </div>
        </section>

        <section class="detail-section">
          <p class="section-title">Danh sách testcase fail</p>
          <div class="overflow-x-auto rounded-xl border border-border-subtle bg-white/5">
            <table class="w-full text-sm">
              <thead class="text-xs uppercase tracking-wide text-text-dim">
                <tr class="border-b border-border-soft text-left">
                  <th class="px-3 py-2 w-[90px]">ID</th>
                  <th class="px-3 py-2">Title</th>
                  <th class="px-3 py-2 w-[90px]">Priority</th>
                  <th class="px-3 py-2 w-[140px]">Module</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border-soft">
                <tr *ngFor="let tc of selectedRun.failedTests">
                  <td class="px-3 py-2 text-text font-semibold">{{ tc.id }}</td>
                  <td class="px-3 py-2 text-text">{{ tc.title }}</td>
                  <td class="px-3 py-2">
                    <span class="badge" [ngClass]="tc.priority === 'High' ? 'badge-danger' : tc.priority === 'Medium' ? 'badge-warn' : 'badge-success'">
                      {{ tc.priority }}
                    </span>
                  </td>
                  <td class="px-3 py-2 text-text">{{ tc.module }}</td>
                </tr>
                <tr *ngIf="!selectedRun.failedTests.length">
                  <td colspan="4" class="px-3 py-3 text-center text-text-dim text-sm">Không có testcase fail.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <div *ngIf="activeRunDetailTab === 'report'" class="tab-panel">
        <app-run-report-embed
          [reportType]="selectedRun.reportType ?? null"
          [reportUrl]="selectedRun.reportUrl ?? null"
        ></app-run-report-embed>
      </div>
    </div>

    <footer class="flex items-center justify-end gap-2 pt-3">
      <button
        type="button"
        class="rounded-lg border border-border-subtle px-4 py-2 text-sm text-text transition hover:bg-white/5"
        (click)="closeRunDetail()"
      >
        Đóng
      </button>
    </footer>
  </div>
</div>

<div *ngIf="toast" class="toast" [ngClass]="toast.type">
  <div class="flex items-center gap-2">
    <span *ngIf="toast.type === 'success'">✅</span>
    <span *ngIf="toast.type === 'warn'">⚠️</span>
    <span *ngIf="toast.type === 'danger'">⛔</span>
    <div class="text-sm font-medium leading-snug">{{ toast.message }}</div>
  </div>
  <button type="button" class="close" (click)="dismissToast()">
    ✕
  </button>
</div>
